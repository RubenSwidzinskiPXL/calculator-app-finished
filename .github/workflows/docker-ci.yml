name: Docker Example
on:
  workflow_dispatch:   # Only manual trigger

jobs:
  docker_build_and_push:
    runs-on: ubuntu-latest
    steps:
      # Checkout code
      - name: Checkout
        uses: actions/checkout@v5.0.0

      # Set up Node.js (optional, only if build/test is required before Docker)
      - name: Set up Node.js
        uses: actions/setup-node@v6.0.0

      # Install dependencies (optional, if you want to run npm install/test)
      - name: Install dependencies
        run: npm install

      # Run tests (optional)
      - name: Run tests
        run: npm test -- --coverage
      - uses: mridang/action-test-reporter@v1.3.0
        with:
          coverage-file: coverage/lcov.info

      # Log in to Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Build and push Docker image with correct tags
      - name: Build and push Docker image
        uses: docker/build-push-action@v6.18.0
        with:
          context: .
          push: true
          # Tag with branch/tag name according to ref type (main/tagged release)
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/your-image-name:latest
            ${{ (github.ref_type == 'tag' && format('{0}/{1}:{2}', secrets.DOCKERHUB_USERNAME, 'your-image-name', github.ref_name)) || '' }}

      # Scan image for CVEs
      - name: Scan image for CVEs
        uses: docker/scout-action@v1
        with:
          image: ${{ secrets.DOCKERHUB_USERNAME }}/your-image-name:latest
